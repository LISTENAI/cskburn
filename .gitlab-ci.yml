stages:
  - build
  - publish

variables:
  LINUX_BUILDER: "registry.cn-beijing.aliyuncs.com/iflyos-service/linux-builder:latest"
  LPM_REGISTRY: "https://integration-registry-lpm.listenai.com"

build-win32:
  stage: build
  script: cmd.exe /c 'chcp 437 && build.bat && cp out\cskburn\Release\cskburn.exe cskburn-win32.exe'
  artifacts:
    paths:
      - cskburn-win32.exe
  tags:
    - csk_builder

build-linux:
  stage: build
  script: |
    docker pull ${LINUX_BUILDER}
    docker run --rm -v ${PWD}:/project ${LINUX_BUILDER} bash -c './build.sh'
    cp out/cskburn/cskburn cskburn-linux
  artifacts:
    paths:
      - cskburn-linux
  tags:
    - iflyos-builder

build-darwin:
  stage: build
  script: |
    export CMAKE_PREFIX_PATH=/usr/local
    ./build.sh
    cp out/cskburn/cskburn cskburn-darwin
  artifacts:
    paths:
      - cskburn-darwin
  tags:
    - ios

bundle:
  stage: publish
  script: echo
  artifacts:
    paths:
      - cskburn-win32.exe
      - cskburn-linux
      - cskburn-darwin
  tags:
    - iflyos-builder

publish:
  stage: publish
  only:
    refs:
      - tags
  script: |
    docker run --rm \
      -v ${PWD}:/project \
      -e LPMRC="${LPMRC}" \
      -e LPM_REGISTRY="${LPM_REGISTRY}" \
      node:lts \
      bash -c 'cd /project && ./publish.sh'
  tags:
    - iflyos-builder

# 错误处理改进指南

本文档提供了改进 cskburn 项目错误处理的具体建议和示例。

## 当前问题

### 1. 不统一的错误码
当前代码使用混合的错误返回方式，缺乏一致性。

### 2. 缺少错误上下文
错误返回时通常没有足够的上下文信息帮助调试。

### 3. goto 语句过多
main.c 中存在大量的 goto 语句用于错误处理，降低了代码可读性。

## 改进建议

### 1. 定义统一的错误码系统
建议创建 `liblog/include/errno_cskburn.h`，定义所有项目特定的错误码。

错误码应该:
- 使用负数表示错误
- 按模块分组 (通用、设备、串口、协议、烧录、文件、USB 等)
- 每个错误有清晰的描述

### 2. 提供错误信息函数
实现以下辅助函数:
- `cskburn_strerror(int err)` - 获取错误描述
- `cskburn_set_error(int err, const char *fmt, ...)` - 设置详细错误信息
- `cskburn_get_last_error(void)` - 获取最后错误的详细信息

### 3. 使用错误处理宏
定义宏来简化常见的错误检查模式:
- `CHECK_RET(cond, err, fmt, ...)` - 检查条件并返回
- `CHECK_CALL(call)` - 检查函数调用
- `CHECK_NULL(ptr, err)` - 检查空指针
- `CHECK_ARG(cond)` - 检查参数有效性
- `CHECK_ALLOC(ptr)` - 检查内存分配

### 4. 改进资源管理
使用以下策略避免资源泄漏:
- 明确的资源获取/释放配对 (open/close)
- 使用 cleanup 属性 (GCC/Clang)
- 统一的错误清理路径

### 5. 重构超长函数
将 main.c 中的长函数拆分为:
- 独立的函数处理不同的烧录模式
- 提取命令行解析逻辑
- 分离验证和错误处理逻辑

## 实施优先级

**高优先级**:
1. 定义统一的错误码
2. 实现错误信息函数
3. 重构核心库的错误处理

**中优先级**:
4. 创建错误处理宏
5. 重构 main.c

**低优先级**:
6. 添加错误处理测试
7. 改进用户错误提示

## 预期效果

实施这些改进后:
- ✅ 错误处理更加一致
- ✅ 调试更加容易
- ✅ 代码更加清晰
- ✅ 用户体验更好
- ✅ 降低 bug 风险

详细的代码示例和完整实现，请参考项目 wiki 或后续的代码重构 PR。
